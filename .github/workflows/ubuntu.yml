name: EXPORT DOCKER SERVICES
on:
  schedule:
    - cron: 0 0 * * 0
  workflow_dispatch: null
jobs:
  check_version:
    runs-on: ubuntu-latest
    outputs:
      new_version_found: ${{ steps.compare_versions.outputs.new_version_found }}
      cached_version_file_found: ${{ steps.cached_version_found.outputs.version_file_found }}
      current_version: ${{ steps.compare_versions.outputs.current_version }}
      cached_version: ${{ steps.cached_version_found.outputs.cached_version }}
    steps:
      - name: CHECKOUT CODE
        uses: actions/checkout@v3
      - name: GET CACHE VERSION FROM CACHE
        id: cache_version
        uses: actions/cache@v3
        with:
          path: .version
          key: fixed-cache-key-for-version
      - name: CHECK IF VERSION FILE EXISTS
        id: cached_version_found
        run: |

          if [ -f ".version" ]; then
            cached_version=$(cat .version)
            echo "Version file found in cache. $cached_version"
            echo "cached_version_file_found=true" >> $GITHUB_ENV
          else
            echo "Version file not found in cache."
            echo "cached_version_file_found=false" >> $GITHUB_ENV
          fi
      - name: GET CURRENT VERSION
        id: get_current_version
        # if: steps.cached_version_found.outputs.cached_version_file_found == 'false'
        run: |

          curl -sL https://qn.whyour.cn/version.yaml -o version.yaml
          echo "Current working directory: $(pwd)" # 打印当前工作目录
          echo "Current working directory files : $(ls -ll)" # 打印当前工作目录

          current_version=$(cat version.yaml | grep version | cut -d ':' -f 2 | tr -d ' "')

          echo "Current version: $current_version" # 直接输出当前版本

          echo "current_version=$current_version" >>$GITHUB_ENV

          echo "$current_version" > .version # 将当前版本写入.version文件
      - name: COMPARE VERSIONS
        id: compare_versions
        run: |

          current_version=$(cat version.yaml | grep version | cut -d ':' -f 2 | tr -d ' "')

          cached_version=$(cat .version)

          echo "Cached version: $cached_version"

          echo "Current version: $current_version" # 使用环境变量

          if [ "$cached_version" != "$current_version" ]; then
            echo "New version found: $current_version"
            echo "new_version_found=true" >> $GITHUB_ENV
          else
            echo "No new version found."
            echo "new_version_found=false" >> $GITHUB_ENV
          fi
  export_docker_images:
    needs: check_version
    if: needs.check_version.outputs.new_version_found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: SETTING DOCKER BUILDX
        uses: docker/setup-buildx-action@v2
      - name: PULL DOCKER IMAGE
        run: |
          docker pull whyour/qinglong:debian
          docker pull whyour/qinglong:latest
      - name: RUN DOCKER CONTAINER
        run: |
          docker run --name qinglong-debian -dit -p 5700:5700 whyour/qinglong:debian

          docker run --name qinglong-latest -dit -p 5701:5700 whyour/qinglong:latest
      - name: CHECK API STATUS
        run: |
          while ! curl -s -w "%{http_code}" http://127.0.0.1:5700/api/public/health |
          grep -q 200; do sleep 1; done

          while ! curl -s -w "%{http_code}" http://127.0.0.1:5701/api/public/health | grep -q 200; do sleep 1; done
      - name: EXECUTE MULTIPLE COMMANDS IN DEBIAN CONTAINER
        run: |
          docker exec qinglong-debian bash -c "pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple"

          docker exec qinglong-debian bash -c "printf 'deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free\n' >/etc/apt/sources.list"

          docker exec qinglong-debian bash -c "printf 'deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free\n' >>/etc/apt/sources.list"

          docker exec qinglong-debian bash -c "printf 'deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free\n' >>/etc/apt/sources.list"
      - name: EXECUTE MULTIPLE COMMANDS IN LATEST CONTAINER
        run: |
          docker exec qinglong-latest bash -c "pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple"

          docker exec qinglong-latest bash -c "sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories"
      - name: STOP CONTAINER
        run: |
          docker stop qinglong-debian
          docker stop qinglong-latest
      - name: COMMIT DOCKER CONTAINER
        run: |
          docker commit qinglong-debian qinglong-debian
          docker commit qinglong-latest qinglong-latest
      - name: SAVE DOCKER IMAGE
        run: |
          docker export -o qinglong-debian.tar qinglong-debian
          docker export -o qinglong-latest.tar qinglong-latest
  create_and_upload_release:
    needs:
      - check_version
      - export_docker_images
    if: needs.check_version.outputs.new_version_found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: CREATE RELEASE
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.check_version.outputs.current_version }}
          release_name: RELEASE ${{ needs.check_version.outputs.current_version }}
          draft: false
          prerelease: false
      - name: UPLOAD DEBIAN RELEASE ASSET
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./qinglong-debian.tar
          asset_name: qinglong-debian.tar
          asset_content_type: application/x-tar
      - name: UPLOAD LATEST RELEASE ASSET
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./qinglong-latest.tar
          asset_name: qinglong-latest.tar
          asset_content_type: application/x-tar
      - name: SAVE VERSION IN CACHE
        uses: actions/cache@v3
        with:
          path: .version
          key: ${{ runner.OS }}-version
          restore-keys: ${{ runner.OS }}-version
      - name: WRITE VERSION TO FILE
        run: echo ${{ needs.check_version.outputs.current_version }} > .version
